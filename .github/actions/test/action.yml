runs:
  using: "Composite"
  steps:
    - name: Test with pytest
      env:
        BRANCH: ${{ github.ref_name}}
      id: pytest
      continue-on-error: true
      run: |
        python -m pip install pytest pytest-html pytest-cov
        pushd src
        cp ../.coveragerc .
        python -m pytest ../tests --junitxml=../test_report/$BRANCH/pytest.xml --html=../test_report/$BRANCH/pytest.html --cov=. --cov-branch --cov-report=term-missing --cov-report=html --cov-report xml
        popd
      shell: bash

    - name: checkout Pages branch
      uses: actions/checkout@v3
      with:
        ref: gh-pages
        path: pages

    - name: Generate Test Report Index
      env:
        BRANCH: ${{ github.ref_name}}
        REPOSITORY: ${{ github.repository}}
      run: |
        rm src/htmlcov/.gitignore
        rm -rf pages/test_report/$BRANCH
        mv test_report/$BRANCH pages/test_report
        mv src/htmlcov pages/test_report/$BRANCH/
        pushd pages/test_report
        echo "<html><head><title>JASMINE Testing Report</title></head><body><h1>JASMINE TESTING REPORT</h1><ul>" > index.html
        find . -name pytest.html | xargs -Ixxx dirname xxx | awk '{print substr($0, 3)}' | xargs -Ixxx echo "<li><a href=\"https://github.com/$REPOSITORY/actions/workflows/pytest.yml?query=branch:xxx\"><img src=\"https://github.com/$REPOSITORY/actions/workflows/pytest.yml/badge.svg?branch=xxx\" alt=\"pytest\" style=\"max-width: 100%;\"></a>xxx<a href=\"xxx/pytest.html\">(Test Report)</a><a href=\"xxx/htmlcov/index.html\">(Test Coverage Report)</a></li>" >> index.html
        echo "</ul></body></html>" >> index.html
        popd
      shell: bash

    - name: Publish Test Report
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ env.GITHUB_TOKEN }}
        publish_dir: ./pages
        keep_files: true

    - name: Send Coverage Report to CodeClimate
      if: ${{ steps.pytest.outcome == 'success'}}
      uses: paambaati/codeclimate-action@v3.0.0
      env:
        CC_TEST_REPORTER_ID: ${{ env.CC_TEST_REPORTER_ID }}
      with:
        debug: false
        coverageLocations: src/coverage.xml:coverage.py

    - name: Notice Error
      if: ${{ steps.pytest.outcome == 'failure' }}
      run: exit 1
      shell: bash
