# JASMINE Telescope 開発者ガイド

## はじめに
このドキュメントは、本リポジトリのソースコードを維持・メンテナンスを行う人を対象に記述しています。（以下開発者と呼びます）

## 用意するもの
開発者は、事前に以下のものを用意してください。
これらは無くても開発を行う事ができますが、より効率的に開発を進めていく上で必要になってくるものです。
また、テストについてはDocker上でパスすることを最優先としてください。

- リファクタリングツール付きのIDE環境（例えばPyCharm等）
  - 関数の名称変更や、引数の変更等を手動で変更すると、時間も掛かりミスも多くなります。
  - 関数名やモジュール名を適切に名称を与えると名前が長くなりがちですが、補完機能で入力をサポートしてくれます
  - コードの整形をある程度規約に則って自動で行ってくれます
- Docker
  - [Dockerメモ](docker/docker_memo.md)に主な理由は書いています
  - pipでインストール出来るのはあくまでPythonのモジュールのみでそのモジュールがPython以外のライブラリに依存する場合、それは各OSで個別に解決する必要が出てきます
    - 現時点では、Dockerの利用を強制していないので、困った時はみんなで解決にはなります。

## 依存パッケージの管理について

外部のパッケージを追加する場合は、そのパッケージが実コードを動作させるために必要なのか、テストを動作させるためだけに必要なのかに応じて記述場所を変更してください。
もし、どちらか判断着かないのであれば、実コードを動作させるための追加と判断して頂いて構いません。

### 実コードを動作させる為に必要な依存パッケージの追加

[requirements.txt](requirements.txt)に書き加えてください。

### テストを動作させる為に必要な依存パッケージの追加

以下の2箇所に変更を加えてください。
**ちなみにテストを動作させる（と言うか、開発を進めるための）パッケージの管理はイケてません。**
別案あれば是非採用したいです。

- [GithubActions用のスクリプト](.github/actions/test/action.yml)の12行辺りに書き加えてください
- [Dockerfile](docker/Dockerfile)の16行辺りを書き換えてください。

ちなみに、テストを動作させる為に必要と判断したものに以下のものがあります。

- pytest-html (pytestの結果をHTML化する)
- pytest-cov (pytest実施時のコードカバレッジを収集する)
- sphinx(厳密に言うとtestでは無いが、APIドキュメントを作成するのに用いている)

### なぜ requirements.txt にすべてを書き足さないのか？

requirements.txtに、書き加えたものは``python setup.py install``実行時に同時にインストールされてしまいます。
インストールという行為は、「利用者のためのもの」と考えると、利用者に不必要なモジュールで利用者のPCのリソースを奪う行為は極力避けるべきです。

## テストの実施方法

テストは、Dockerコンテナ上で行う場合は、``pytest [テスト対象ディレクトリ or ファイル]``と叩けばテストが行えます。
Dockerコンテナを利用しない場合は、PYTHONPATHに以下のディレクトリを追加した上で実施してください。
(Unixディストリビューションによって書き方は変わるかも知れません。)

``
export PYTHONPATH=[projectroot]/src:[projectroot]/tests:[projectroot]/slowtests
``

## テストが動かないとき

複数人で同時並行に開発を進めているので、環境は常に変わり続けます。
昨日まで動いていたテストが動かなくなることもあります。その場合は、以下の事を試してみてください。

### PYTHONPATHとカレントディレクトリを確認する

テストや、モジュールのパスが解決出来ていない可能性があります。
特に``PYTHONPATH``が相対パスで指定されている場合は、カレントディレクトリを確認してみてください。
``PYTHONPATH``に何が指定してあるかは以下のコマンドで確認できます。

``env | grep PYTHONPATH``


### 依存モジュールを再取得する

新たにモジュールが追加されている場合があります。
以下のコマンドを実行することで必要なモジュールの取得が行えます。

``python -m pip install -r requirements.txt``

または、

``python setup.py install``

### setuptoolsのバージョンアップが必要

新たなモジュールは、新しいバージョンのsetuptoolsを必要としている場合があります。
その場合は、上記の手順でエラーが起こるかも知れません。
setuptoolsは以下の手順で更新可能です。

``python -m pip install --upgrade pip setuptools``

### Dockerコンテナを再構築する

Dockerコンテナ利用者のみ

あるモジュールを加えるときに、PYTHON以外のライブラリを必要としている場合、ここまでの手順を実行しても解決出来ない場合があります。
その場合は、Dockerコンテナを停止した上で、Dockerコンテナの再構築を行ってみてください。
Dockerコンテナの停止や再構築方法は、[Dockerメモ](docker/docker_memo.md)を参照してください。

なお、Dockerコンテナの再構築を行えば、ここまでの手順は全て行います。Dockerコンテナ再構築を最初に行わないのは、この行為自体そこそこ時間が掛かる（1m〜5mくらい？）ためです。
時間を考慮しないなら、この方法だけ試しても良いかもしれません。

### それでも動かない!!

テストコード記述者が、環境を意識せずにテストコードを記載している場合があります。
エラーが起こっている行を直近触った人へ直接コンタクトを取ってみてください。
``git blame``コマンドを使えば、そのコードを最後に更新した人がわかります。

``git blame [ファイル名]``

## (参考)Github Actionsワークフロー一覧

以下は、現在動作しているワークフロー一覧です。

|ワークフロー名| トリガー|概要|
---|---|---
|build| プルリクエスト作成/更新時(main/develop)<br/>プッシュ時(main/develop) | telescope baselineがインストール出来るかどうかのチェック|
|cleanup| ブランチ削除時| 当該ブランチのテストレポートを削除|
|docgen|プッシュ時(main/develop)| sphinxによりAPIドキュメントを作成|
|pytest|プッシュ時| tests配下のテストコードを実行しレポートを作成。レポートは[こちら](https://jasmine-mission.github.io/telescope_baseline/test_report/index.html)|
|slowtest|JST(22:00)<br/>手動実行| developブランチのコードのslowtest配下のテストを実施。<br/>手動実施は[こちら](https://github.com/JASMINE-Mission/telescope_baseline/actions/workflows/slowtest.yml)にアクセスして[Run workflow]クリックし、ブランチを指定して実行 |
